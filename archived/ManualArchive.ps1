




<# old, specified locations
$standardArchiveLocations = @("D:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Reports\Submissions\_Archive")
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Reports\Audits\ARCHIVE"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Reports\Evidence Reports\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\101571-BG-ECO2-HHCRO\Reports\Submissions\_Archive"
$standardArchiveLocations += "D:\Clients\Npower Northern Ltd\101887-npower_ECO_CERO_July-Sept17\Reports\Submissions\_Archive"
$standardArchiveLocations += "D:\Internal\Residential\ECO\Archive"
$standardArchiveLocations += "D:\Internal\Residential\ECO\Compliance\Team folders\Debs\2nd checking - to do\archive"
$standardArchiveLocations += "D:\Internal\Residential\ECO\Compliance\Team folders\Catherine\4_1st Check\Archive"
$standardArchiveLocations += "D:\Internal\Residential\ECO\Compliance\Team folders\Becky T\4.In first check\_archive"
$standardArchiveLocations += "D:\Internal\Residential\ECO\Compliance\Team folders\Becky T\Archive"
$standardArchiveLocations += "D:\Internal\Residential\ECO\Compliance\Team folders\Ollie\_Archive"
$standardArchiveLocations += "D:\Suppliers\Energy Low Ltd\14. Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\Addvertising Green Limited\Debs Archive"
$standardArchiveLocations += "D:\Suppliers\Bartons of Duke Street\14. Submissions\_Archive"
$standardArchiveLocations += "D:\Suppliers\DB Insulations\Debs Archive"
$standardArchiveLocations += "D:\Suppliers\Evolve Home Energy Solutions\13. Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\Climate Insulation\14. Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\Insulate UK Ltd\SSE HHCRO Delivery\Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\JJ Crump & Sons\Debs archive"
$standardArchiveLocations += "D:\Suppliers\Eco-Worx Ltd\Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\Reach 4 Savings\1. Archive"
$standardArchiveLocations += "D:\Suppliers\Thermabead Ltd\Debs Archive"
$standardArchiveLocations += "D:\Suppliers\Marshall & McCourt Plumbing & Heating Contracts Ltd\14. Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\Well Warm Ltd\Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\The Green Deal Factory Ltd\14. _Submissions\Archive"
$standardArchiveLocations += "D:\Suppliers\The Green Eco Company NW\_ Archive ECO2t"
$standardArchiveLocations += "D:\Suppliers\Insulation (Whalley) Ltd\_Archive ECO2t"

$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.10\_Archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.10\_BG Submission 1_Standard Insulation\BG_ETT6854\ETT6854002\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.10\_BG Submission 1_Standard Insulation\BG_ETT6855\ETT6855004\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.10\_BG Submission 1_Standard Insulation\BG_ETT6859\ETT6859001\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.10\_BG Submission 1_Standard Insulation\BG_ETT6859\ETT6859002\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.10\_BG Submission 1_Standard Insulation\BG_ETT6870\ETT6870001\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.10\_BG Submission 1_Standard Insulation\BG_ETT6870\ETT6870002\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6883001\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6883002\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6892001\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6901001\Archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6910001\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6916001\Archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6916002\Archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6916003\Archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6943002\Archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\ETT6943004\ARCHIVE"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\RRI6917002\_archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 2_Standard Insulation\RRI6958001\_Archive"
$standardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions\2018.11\_BG Submission 3_SWA Insulation\RRI6915001\Archive"
$standardArchiveLocations += "D:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.04\2019.05.13_Sub77\23.04.19_EDF_Harry_GEC_DBR7823&UFI7824_13.04.2019\BOILER 117, Bradford Road, Keighley, West Yorkshire, BD21 4BL\archive"
$standardArchiveLocations += "D:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.04\2019.05.13_Sub77\23.04.19_EDF_Harry_GEC_DBR7823&UFI7824_13.04.2019\BOILER 127, St. Leonards Road, Bradford, West Yorkshire, BD8 9QB\archive"
$standardArchiveLocations += "D:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.04\2019.05.13_Sub77\23.04.19_EDF_Harry_GEC_DBR7823&UFI7824_13.04.2019\BOILER 6, Agar Terrace, Bradford, West Yorkshire, BD8 9QH\archive"
$standardArchiveLocations += "D:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.04\2019.05.13_Sub77\23.04.19_EDF_Harry_GEC_DBR7823&UFI7824_13.04.2019\BOILER 23, Knaresborough Drive, Huddersfield, West Yorkshire, HD2 2PR\archive"
$standardArchiveLocations += "D:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.04\2019.05.13_Sub77\23.04.19_EDF_Harry_GEC_DBR7823&UFI7824_13.04.2019\6, Agar Terrace, Bradford, West Yorkshire, BD8 9QH (1)\archive"
$standardArchiveLocations += "D:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.04\2019.05.13_Sub77\23.04.19_EDF_Harry_GEC_DBR7823&UFI7824_13.04.2019\117, Bradford Road, Keighley, West Yorkshire, BD21 4BL\archive"


#
$nonStandardArchiveLocations = @("D:\Clients\Housing and Care 21\_Business Development\Archive")
$nonStandardArchiveLocations += "D:\Clients\British Gas Trading Limited\102114-BG ECO3 Delivery - Q4 2018\Reports\Submissions"
$nonStandardArchiveLocations += "D:\Clients\London Borough of Hounslow Council\_Business Development\ECO CBR 2018\LBO Hounslow"
$nonStandardArchiveLocations += "D:\Clients\Trust Housing Association Ltd\_Business Development\ECO\ECO CBR 2018"
$nonStandardArchiveLocations += "D:\Clients\Bron Afon Community Housing\_Business Development\Archive"
$nonStandardArchiveLocations += "D:\Clients\Golden Gates Housing Trust\101124-Golden Gates Tenant Engagement"
$nonStandardArchiveLocations += "D:\Clients\Department of Energy and Climate Change\101304-DECC - In Use Factor's Review"
$nonStandardArchiveLocations += "D:\Clients\Red Kite Community Housing Ltd\101402-Red Kite Stock Model and Strategy"
$nonStandardArchiveLocations += "D:\Clients\Knightstone Housing Association Ltd\101217-Knightstone Stock Remodelling"
$nonStandardArchiveLocations += "D:\Clients\Knightstone Housing Association Ltd\101150-Knightsone U_Resi_Stock"

$nonStandardArchiveLocations = @("X:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Ops\TM\British Gas - TM\2014")
$nonStandardArchiveLocations += "X:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Ops\TM\British Gas - TM\2015"
$nonStandardArchiveLocations += "X:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Ops\TM\British Gas - TM\2016"
$nonStandardArchiveLocations += "X:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Reports\Submissions\District Heating checking\archive"
$nonStandardArchiveLocations += "X:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Reports\Audits\ACTIVE\OnSite Audit 271016"
$nonStandardArchiveLocations += "X:\Clients\British Gas Trading Limited\101233.001-BG ECO 2 - Communal Heating\Reports\ECOhub Reports\To BG"
$nonStandardArchiveLocations += "X:\Clients\Npower Northern Ltd\101626-npower_ECO_HHCRO 2016"
$nonStandardArchiveLocations += "X:\Internal\Residential\ECO\Compliance\Team folders\Debs\#Green Eco July"
$nonStandardArchiveLocations += "X:\Internal\Residential\ECO\Compliance\Team folders\Debs\STUFF FOR STU"
$nonStandardArchiveLocations += "X:\Internal\Residential\ECO\Compliance\Team folders\Debs\VARIOUS EVIDENCE - internal TM and H&S site visits"
$nonStandardArchiveLocations += "X:\Internal\Residential\ECO\Compliance\Team folders\Catherine"
$nonStandardArchiveLocations += "X:\Internal\Finance\Month End\2013-14"
$nonStandardArchiveLocations += "X:\Internal\Finance\Month End\2014-15"
$nonStandardArchiveLocations += "X:\Internal\Products & Technology\Sales\DECs\Data"
$nonStandardArchiveLocations = @("X:\Clients\Anchor Trust\_Business Development\ECO\ECO CBR\CBR programme 2017")
$nonStandardArchiveLocations += "X:\Clients\Npower Northern Ltd\ECO2T"
$nonStandardArchiveLocations += "X:\Clients\Unite Integrated Solutions plc\101754-EM_Unite_Platform_Development"
$nonStandardArchiveLocations += "X:\Clients\Unite Integrated Solutions plc\101623-EM_Compliance & Standards_MEES"
$nonStandardArchiveLocations += "X:\Clients\The Regenda Group\_Business Development\ECO\ECO CBR 2017"
$nonStandardArchiveLocations += "X:\Clients\CityWest Homes\_Business Development\ECO\ECO CBR 2016"
$nonStandardArchiveLocations += "X:\Clients\CityWest Homes\_Business Development\ECO\City West CBR 2015 plans"
$nonStandardArchiveLocations += "X:\Clients\West Sussex County Council\101880-ESE_DE_ WSCC_Manor_Royal_options"


$nonStandardArchiveLocations = @("X:\Clients\CityWest Homes\_Business Development\ECO\ECO CBR 2018")
$nonStandardArchiveLocations += "D:\Clients\Harlow District Council\_Business Development\ECO CH"
$nonStandardArchiveLocations += "D:\Clients\London Borough of Southwark\102121-DE_OKR-Housing Boiler Room Surveys"
$nonStandardArchiveLocations += "D:\Clients\Bron Afon Community Housing\101627-ESE_Design & Build_Bron_Afon_Cwmbran"
$nonStandardArchiveLocations += "D:\Clients\Kingston University Higher Education Cor\102006-DE_ Kingston Uni_DHS Plant Rm Audit"
$nonStandardArchiveLocations += "D:\Clients\Sanctuary Housing Association\101835-ESE_13 Sites EE Investigations"
$nonStandardArchiveLocations += "D:\Clients\High Peak Community Housing\_Business Development\ECO\ECO CBR 2017"

$nonStandardArchiveLocations = @("X:\Clients\npower Ltd\102159-NPower ECO3 Delivery-Q1&Q2 2019\Reports\Submissions\2019.04")
$nonStandardArchiveLocations += "X:\Clients\British Gas Trading Limited\102148-BG ECO3 Delivery 2019\Reports\Submissions\2019.05"
$nonStandardArchiveLocations += "X:\Clients\British Gas Trading Limited\102148-BG ECO3 Delivery 2019\Reports\Submissions\2019.06"
$nonStandardArchiveLocations += "X:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.06"
$nonStandardArchiveLocations += "X:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.05"
$nonStandardArchiveLocations += "X:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.04"
$nonStandardArchiveLocations += "X:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.03"
$nonStandardArchiveLocations += "X:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.02"
$nonStandardArchiveLocations += "X:\Clients\EDF Energy\102149-EDF ECO3 Delivery - 2019\Reports\Submissions\2019.01"


#
#$standardArchiveLocations += "X:\Clients\British Gas Trading Limited\101814-P&T_TI–Int British Gas Guys St Thomas"
#$standardArchiveLocations = @("D:\SH")

#>


<#//Needs Testing/New Attempt at automating the pickup of Archive folders#>

<#Sort the logging#>
$logName = "Manual Archive $(Get-Date -Format "yyMMdd").log"

<#Find all Archive Folders that aren't Symbolic links#>
$Target = "D:\Clients\EmilyArchiveTest"
$standardArchiveLocations = Get-ChildItem $Target "*Archive" -Recurse | Where-Object { $_.LinkType -ne "SymbolicLink" }
$standardArchiveLocations.FullName




function archive-folder($folderToArchive){
    Invoke-Command -ScriptBlock {& "C:\Windows\system32\robocopy.exe" "$($folderToArchive.Replace('X:\','D:\'))" "$($folderToArchive.Replace('X:\','E:\X\').Replace('D:\','E:\X\').Replace('Y:\','E:\X\'))" "/E" "/MOVE" "/COPY:DATSO" "/DCOPY:DAT" "/XJD" "/LOG+:C:\Scripts\Logs\$logName" "/R:1" "/W:1" "/NP" "/B"} 
    #/E - Include all subfolders
    #/MOVE - Delete source after successful copy
    #/COPY:DATSO - Copy Data, Attributes, Timestamps, Security & Owner for files. Security is for auditing as the Archives Share only had Read permissions
    #/DCOPY:DAT - Copy Data, Attributes, Timestamps for directories. 
    #/XJD - Exclude Junctions for directories (we create SymLinks later to point to the archive location, and we don't want to follow any of these a second time if we're re-archiving a directory)
    #/LOG - Log what happens
    #/R - Retry 1 time. It'll either work or it won't - there's not much point in retrying this more than once.
    #/W - Wait 1 second. If the file's locked, it's unlikely to be unlocked in 30 seconds, so just retry faster in case it was a network issue.
    #/NP - Don't fill the log file with progress percentages for large files
    #/B - Use backup mode, just in case there are permission problems
    }

#Map a drive if it's not already there
#if((Test-Path -Path "X:\") -eq $false){Invoke-Command -ScriptBlock {& "net" "use X: \\sustainltd.local\data"}}
if((Test-Path -Path "X:\") -eq $false){New-PSDrive -PSProvider FileSystem -Root "\\sustainltd.local\data" -Name X }
if((Test-Path -Path "Y:\") -eq $false){New-PSDrive -PSProvider FileSystem -Root "E:\X" -Name Y }
#Try this in cmd (not as Admin) if it still deosn't work :)
#Subst Y: E:\X
$standardArchiveLocations | %{
    write-host -ForegroundColor Yellow "Archiving $_"
    archive-folder -folderToArchive $_
    #Recreate archived folder and create SymLink inside it
    New-Item -Path $_ -ItemType Directory
    New-Item -Path $($_+"\"+$(Split-Path $_ -Leaf)) -ItemType SymbolicLink -Value $($_.Replace('X:\','\\sustainltd.local\ArchivedData\Archives\X\'))
    }
<#foreach ($nkld in $standardArchiveLocations){
    write-host -ForegroundColor Yellow "Archiving $nkld"
    archive-folder -folderToArchive $nkld
    #Recreate archived folder and create SymLink inside it
    New-Item -Path $nkld -ItemType Directory
    New-Item -Path $($nkld+"\"+$(Split-Path $nkld -Leaf)) -ItemType SymbolicLink -Value $($nkld.Replace('X:\','\\sustainltd.local\ArchivedData\Archives\X\'))
 
    }
    #>
$nonStandardArchiveLocations | % {
    $location = $_ #.Replace("D:\","X:\")
    write-host -ForegroundColor Yellow "Archiving $location"
    archive-folder -folderToArchive $location
    #Recreate archived folder and create SymLink inside it
    #New-Item -Path $_ -ItemType Directory
    New-Item -Path $location -ItemType SymbolicLink -Value $($location.Replace('X:\','\\sustainltd.local\ArchivedData\Archives\X\'))
    }

#Replace folder with SymLink (for Client/Project folders)
#New-Item -Path $folderToArchive -ItemType SymbolicLink -Value $($folderToArchive.Replace('X:\','\\sustainltd.local\ArchivedData\Archives\X\'))


Start-DedupJob -Type GarbageCollection -Priority High -Volume d: -InputOutputThrottleLevel None
Start-DedupJob -Type Optimization -Priority High -Volume d: -InputOutputThrottleLevel None
Start-DedupJob -Type GarbageCollection -Priority High -Volume D: -Full -InputOutputThrottleLevel None
Start-DedupJob -Type Optimization -Priority High -Volume D: -Full -InputOutputThrottleLevel None

Get-DedupJob